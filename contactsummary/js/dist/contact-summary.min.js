define("contact-summary/modules/filters",["common/angular"],function(t){"use strict";return t.module("contactsummary.filters",[])}),define("contact-summary/modules/services",["common/angular"],function(t){"use strict";return t.module("contactsummary.services",[])}),define("contact-summary/modules/settings",["common/angular"],function(t){"use strict";return t.module("contactsummary.settings",[]).constant("settings",{classNamePrefix:"contactSummary-",contactId:decodeURIComponent((new RegExp("[?|&]cid=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null,debug:!0,pathApp:"",pathRest:CRM.url("civicrm/ajax/rest"),pathBaseUrl:CRM.vars.contactsummary.baseURL+"/",pathTpl:"views/"})}),define("contact-summary/modules/controllers",["common/angular"],function(t){"use strict";return t.module("contactsummary.controllers",[])}),define("contact-summary/controllers/contactSummary",["contact-summary/modules/controllers","contact-summary/modules/settings"],function(t){"use strict";function e(t,e){t.debug("Controller: ContactSummaryCtrl");var n=e.pathBaseUrl+e.pathTpl;this.partials={keyDetails:n+"/include/keyDetails.html",keyDates:n+"/include/keyDates.html"},this.ready=!1}t.controller("ContactSummaryCtrl",["$log","settings",e])}),define("contact-summary/services/api",["contact-summary/modules/services"],function(t){"use strict";t.factory("ApiService",["$http","$q",function(t,e){function n(t,e,n,r){if(!angular.isDefined(t))throw new Error("Entity name not provided");if(!angular.isDefined(n))throw new Error("Action not provided");return e=angular.extend({entity:t,action:n,sequential:1,json:1,rowCount:0},e),r?jQuery.param(e):e}function r(n,r,o){return o=angular.extend({method:n,url:"/civicrm/ajax/rest"},"post"===n?{data:r}:{params:r},o),t(o).then(function(t){return t.is_error?e.reject(t):t.data}).catch(function(t){return t})}return{get:function(t,e,o){return r("get",n(t,e,"get"),o)},post:function(t,e,o,c){return c=angular.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},c),r("post",n(t,e,o,!0),c)},getValue:function(t,e){},create:function(t,e){},update:function(t,e){},delete:function(t,e){}}}])}),define("contact-summary/services/item",["common/moment","contact-summary/modules/services"],function(t,e){"use strict";function n(){var t={};return t.createInstance=function(){var t=Object.create(this);return t.item={},t},t.get=function(){return this.item},t.set=function(t){if(!angular.isObject(t))throw new TypeError("Data must be of type Object");this.item=t},t.setKey=function(t,e){this.item[t]=e},t}e.factory("ItemService",n)}),define("contact-summary/services/model",["contact-summary/modules/services","contact-summary/services/item"],function(t){"use strict";function e(t){var e={};return e.data={},e.createInstance=function(){var e=Object.create(this);return e.data=t.createInstance(),e},e.getData=function(){return this.data.get()},e.setData=function(t){this.data.set(t)},e.setDataKey=function(t,e){this.data.setKey(t,e)},e}t.factory("ModelService",["ItemService",e])}),define("contact-summary/services/contactDetails",["common/lodash","common/moment","contact-summary/modules/services","contact-summary/modules/settings","contact-summary/services/api","contact-summary/services/model"],function(t,e,n){"use strict";function r(n,r,o,c,a){function i(){var r=n.defer();if(t.isEmpty(u.getData())){var c=a.contactId;o.get("Contact",{contact_id:c,return:"birth_date"}).then(function(t){if(0===t.values.length)throw new Error("Contact with ID "+c+" not found");var n=t.values[0].birth_date,o=e(n,"YYYY-MM-DD").isValid()?s(n):"";u.setDataKey("id",c),u.setDataKey("dateOfBirth",n),u.setDataKey("age",o),r.resolve()}).catch(function(t){r.reject(t)})}else r.resolve();return r.promise}function s(t){return e().diff(e(t,"YYYY-MM-DD"),"years")}r.debug("Service: ContactDetailsService");var u=c.createInstance();return u.get=function(){var t=this,e=n.defer();return i().then(function(){e.resolve(t.getData())}),e.promise},u}n.factory("ContactDetailsService",["$q","$log","ApiService","ModelService","settings",r])}),define("contact-summary/services/contract",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/contactDetails","contact-summary/services/model"],function(t,e){"use strict";function n(e,n,o,c,a){function i(){l.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}}}function s(){var n=e.defer();return t.isEmpty(l.collection.get())?l.getContracts().then(u).finally(function(){n.resolve()}):n.resolve(),n.promise}function u(){var t=e.defer(),r=[];return angular.forEach(m,function(t){var e={};e.id=t.id,e.is_primary=t.is_primary,e.is_current=t.is_current,e.revision_id=null,t.api_HRJobContractRevision_getcurrentrevision&&(e.revision_id=t.api_HRJobContractRevision_getcurrentrevision.values.id);var n=l.getContractDetails(t.id).then(function(t){e.title=t.title,e.start_date=t.period_start_date,e.end_date=t.period_end_date,e.type=t.contract_type,e.pay=t.pay,e.hours=t.hours}).then(function(){l.collection.insertItem(t.id,e)});r.push(n)}),e.all(r).catch(function(t){n.error("Something went wrong",t)}).finally(function(){t.resolve()}),t.promise}n.debug("Service: Contract Service");var l={};i(),l.getCollection=function(){return this.collection.get()},l.get=function(){var t=this;return s().then(function(){return t.getCollection()})},l.getPrimary=function(){return this.get().then(function(e){var n=t.sortBy(e,function(t){return[t.end_date,+t.is_primary]});return t.last(n)||{}})},l.resetContracts=function(){m=[],r={},i()},l.getContracts=function(){var n=e.defer();return t.isEmpty(m)?a.get().then(function(t){var e={contact_id:t.id,"api.HRJobContractRevision.getcurrentrevision":{jobcontract_id:"$value.id"}};return o.get("HRJobContract",e)}).then(function(t){var e=t.values.filter(function(t){return 0===parseInt(t.deleted)});return 0===e.length?n.reject("No job contract found"):(m=e,void n.resolve(m))}).catch(function(t){n.reject(t)}):n.resolve(m),n.promise},l.getContractDetails=function(t){var n=function(t){var e={};0!==t.api_HRJobPay_get.values.length&&(e.amount=t.api_HRJobPay_get.values[0].pay_amount,e.currency=t.api_HRJobPay_get.values[0].pay_currency),t.pay=e},c=function(t){var e={};0!==t.api_HRJobHour_get.values.length&&(e.amount=t.api_HRJobHour_get.values[0].hours_amount,e.unit=t.api_HRJobHour_get.values[0].hours_unit),t.hours=e},a={jobcontract_id:t,"api.HRJobPay.get":{jobcontract_id:t},"api.HRJobHour.get":{jobcontract_id:t}};return r.getContractDetails||(r.getContractDetails=o.post("HRJobDetails",a,"get").then(function(r){if(0===r.values.length)return e.reject("No details found for contract revision with ID "+t);var o=r.values[0];return n(o),c(o),o})),r.getContractDetails},l.getLengthOfService=function(){var t=e.defer();return a.get().then(function(t){return o.post("HRJobContract",{sequential:0,contact_id:t.id},"getlengthofserviceymd")}).then(function(e){e.is_error?t.reject(e):t.resolve(e.values)}).catch(function(e){t.reject(e)}),t.promise};var m=[];return l}var r={};e.factory("ContractService",["$q","$log","ApiService","ModelService","ContactDetailsService",n])}),define("contact-summary/services/jobRole",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/contract","contact-summary/services/model"],function(t,e){"use strict";function n(e,n,r,o,c){function a(){var n=e.defer();return t.isEmpty(i.collection.get())?c.get().then(function(t){var o=[];return angular.forEach(t,function(t){o.push(t.id)}),0===o.length?e.reject("No job roles found for contracts"):void r.post("HrJobRoles",{job_contract_id:{IN:o}},"get").then(function(t){if(0===t.values.length)return e.reject("No job roles found for contracts");var n=t.values.map(function(t){return{id:t.id,title:t.title,department:t.department,status:t.status,start_date:t.start_date,end_date:t.end_date}});i.collection.set(n)}).finally(function(){n.resolve()})}):n.resolve(),n.promise}n.debug("Service: JobRoleService");var i={};return i.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},i.getCollection=function(){return this.collection.get()},i.get=function(){var t=this;return a().then(function(){return t.getCollection()})},i}e.factory("JobRoleService",["$q","$log","ApiService","ModelService","ContractService",n])}),define("contact-summary/controllers/keyDates",["common/moment","contact-summary/modules/controllers","contact-summary/services/contract","contact-summary/services/jobRole","common/services/pub-sub"],function(t,e){"use strict";function n(t){this.dates.push({title:t.title+" (Start)",date:t.start_date,future:r(t.start_date)}),t.end_date&&this.dates.push({title:t.title+" (End)",date:t.end_date,future:r(t.end_date)})}function r(e){return t().diff(e)<0}function o(e,o,c,a){e.debug("Controller: KeyDatesCtrl");var i=this;this.ready=!1,this.dates=[],this.activeContracts=0,this.activeRoles=0;var s=function(){o.get().then(function(t){return angular.forEach(t,function(t){n.call(i,t),"1"===t.is_current&&i.activeContracts++}),c.get()}).then(function(e){angular.forEach(e,function(e){var n=t(e.end_date);n.isValid()&&!r(n)||i.activeRoles++})}).finally(function(){i.ready=!0})}.bind(this),u=function(){this.dates=[],s()}.bind(this);s(),a.subscribe("contract-refresh",u)}e.controller("KeyDatesCtrl",["$log","ContractService","JobRoleService","pubSub",o])}),define("contact-summary/controllers/keyDetails",["common/moment","contact-summary/modules/controllers","contact-summary/services/contactDetails","contact-summary/services/contract","common/services/pub-sub"],function(t,e){"use strict";function n(t,e,n,r){t.debug("Controller: KeyDetailsCtrl"),this.ready=!1;var o=function(){e.get().then(function(t){return this.contactDetails=t,n.getPrimary()}.bind(this)).then(function(t){return _.isEmpty(t)?void(this.primaryContract=null):void(this.primaryContract=t)}.bind(this)).then(function(t){return n.getLengthOfService()}).then(function(t){this.lengthOfService=t}.bind(this)).finally(function(){this.ready=!0}.bind(this))}.bind(this),c=function(){n.resetContracts(),e.data.item={},o()};o(),r.subscribe("contract-refresh",c)}e.controller("KeyDetailsCtrl",["$log","ContactDetailsService","ContractService","pubSub",n])}),define("contact-summary/modules/components",["common/angular"],function(t){"use strict";return t.module("contactsummary.components",[])}),define("contact-summary/components/leave-widget/leave-widget.component",["contact-summary/modules/components"],function(t){function e(){console.log("## INIT ##")}t.component("leaveWidget",{controller:e,controllerAs:"leaveWidget",templateUrl:["settings",function(t){return t.pathBaseUrl+t.pathTpl+"components/leave-widget/leave-widget.html"}]})}),define("contact-summary/modules/directives",["common/angular"],function(t){"use strict";return t.module("contactsummary.directives",[])}),define("contact-summary/directives/donutChart",["common/d3","contact-summary/modules/directives"],function(t,e){"use strict";function n(t){this.height=this.width=t[0].clientWidth,this.radius=this.width/2||60,this.thickness=this.thickness||15}function r(){return t.svg.arc().innerRadius(this.radius-this.thickness).outerRadius(this.radius)}function o(e,n,r){var o=t.scale.category20();return e.selectAll("path").data(r).enter().append("path").attr("fill",function(t,e){return o(e)}).attr("class",function(t,e){return"chart-color-"+e}).attr("d",n)}function c(){var e=t.layout.pie().sort(null).value(function(t){return t.value[this.itemKey]}.bind(this));return e(t.entries(this.items))}function a(e){return t.select(e).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.width/2+","+this.height/2+")")}e.directive("csDonutChart",["$log",function(t){return t.debug("Directive: csDonutChart"),{controllerAs:"CsDonutChartCtrl",restrict:"AE",scope:{radius:"@",thickness:"@",items:"=",itemKey:"@",ready:"="},controller:["$scope","$element",function(t,e){this.drawChart=function(){n.call(angular.extend(this,t),e),o(a.call(this,e[0]),r.call(this),c.call(this))}}],link:function(t,e,n,r){var o=t.$watch(function(){return t.ready},function(t,e){t===!0&&(r.drawChart(),o())})}}}])}),define("contact-summary/app",["common/angular","contact-summary/modules/filters","contact-summary/modules/services","contact-summary/modules/settings","contact-summary/controllers/contactSummary","contact-summary/controllers/keyDates","contact-summary/controllers/keyDetails","contact-summary/components/leave-widget/leave-widget.component","contact-summary/directives/donutChart"],function(t){var e=t.module("contactsummary",["ngRoute","ngResource","ui.bootstrap","common.services","contactsummary.controllers","contactsummary.components","contactsummary.directives","contactsummary.filters","contactsummary.services","contactsummary.settings"]);e.config(["settings","$routeProvider","$resourceProvider","$httpProvider","$logProvider",function(t,e,n,r,o){o.debugEnabled(t.debug),e.when("/",{controller:"ContactSummaryCtrl",controllerAs:"ContactSummaryCtrl",templateUrl:t.pathBaseUrl+t.pathTpl+"mainTemplate.html",resolve:{}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,r.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),e.run(["settings","$rootScope","$q","$log",function(t,e,n,r){r.debug("app.run"),e.pathTpl=t.pathTpl,e.prefix=t.classNamePrefix}])}),function(t,e){e.config({urlArgs:"bust="+(new Date).getTime(),paths:{"contact-summary":t.vars.contactsummary.baseURL+"/js/src/contact-summary"}}),e(["contact-summary/app"],function(){document.dispatchEvent("function"==typeof window.CustomEvent?new CustomEvent("contactsummaryReady"):function(){var t=document.createEvent("Event");return t.initEvent("contactsummaryReady",!0,!0),t}())})}(CRM,require);